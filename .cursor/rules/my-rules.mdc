---
description: AI SSH Assistant é¡¹ç›®å¼€å‘è§„åˆ™å’Œæœ€ä½³å®è·µ
globs:
alwaysApply: true
---

# é¡¹ç›®å¼€å‘è§„åˆ™

## ğŸ—ï¸ æ¶æ„åŸåˆ™

### 1. åŒæ¨¡å¼æœåŠ¡æ¶æ„
- **å¿…é¡»**ä½¿ç”¨ç»Ÿä¸€çš„æœåŠ¡æ¥å£ï¼Œæä¾›æœ¬åœ°ï¼ˆLocal IPCï¼‰å’Œäº‘ç«¯ï¼ˆRemote APIï¼‰ä¸¤ç§å®ç°
- **ç¦æ­¢**åœ¨ç»„ä»¶ä¸­ç›´æ¥åˆ¤æ–­å­˜å‚¨æ¨¡å¼æˆ–ç›´æ¥è°ƒç”¨ IPC/API
- **ä½¿ç”¨** `createService(LocalImpl, ApiImpl)` è‡ªåŠ¨é€‰æ‹©å®ç°

```typescript
// âœ… æ­£ç¡®
import { chatService } from '@/services/chat.service'
const sessions = await chatService.getSessions()

// âŒ é”™è¯¯
if (isLocalMode) {
  await window.electronAPI.chat.getSessions()
} else {
  await fetch('/api/chat/sessions')
}
```

### 2. çŠ¶æ€ç®¡ç†
- **ç¦æ­¢**ä½¿ç”¨ Pinia Storeï¼ˆå·²å®Œå…¨åºŸå¼ƒå¹¶åˆ é™¤ï¼‰
- **ä½¿ç”¨** Vue Composables ç®¡ç†å…¨å±€ UI çŠ¶æ€ï¼ˆå¦‚ `useApp`, `useTheme`ï¼‰
- **ä½¿ç”¨**ç›´æ¥æœåŠ¡è°ƒç”¨è·å–ä¸šåŠ¡æ•°æ®
- **å­˜å‚¨ç›®å½•å·²åˆ é™¤**: `apps/desktop/src/stores/` ä¸åº”å†åˆ›å»º

### 3. userId å¤„ç†
- **ç¦æ­¢**ç»„ä»¶æ‰‹åŠ¨è·å–æˆ–ä¼ é€’ userId
- **å¿…é¡»**ç”±æœåŠ¡å±‚è‡ªåŠ¨å¤„ç†ï¼š
  - æœ¬åœ°æ¨¡å¼ï¼šå›ºå®šä½¿ç”¨ `'local-user'`
  - äº‘ç«¯æ¨¡å¼ï¼šä» JWT Token è‡ªåŠ¨æå–

```typescript
// âœ… æ­£ç¡® - æœåŠ¡å±‚è‡ªåŠ¨å¤„ç†
class ChatLocalImpl {
  async getSessions() {
    const userId = this.getUserId()  // è‡ªåŠ¨è¿”å› 'local-user'
    return window.electronAPI.chat.getSessions(userId)
  }
}

// âŒ é”™è¯¯ - ç»„ä»¶æ‰‹åŠ¨å¤„ç†
const userId = localStorage.getItem('userId')
await chatService.getSessions(userId)
```

## ğŸ“ ä»£ç è§„èŒƒ

### 1. API è·¯å¾„è§„èŒƒ
- **ç¦æ­¢**åœ¨ API å®ç°ä¸­æ·»åŠ  `/api` å‰ç¼€ï¼ˆBaseApiImpl å·²åŒ…å« `/api/v1`ï¼‰
- **æ ¼å¼**: `/æ¨¡å—/æ“ä½œ` æˆ– `/æ¨¡å—/:id`

```typescript
// âœ… æ­£ç¡®
class ChatApiImpl extends BaseApiImpl {
  async getChatTree() {
    return this.get('/chat/tree')  // æœ€ç»ˆ: /api/v1/chat/tree
  }
}

// âŒ é”™è¯¯
return this.get('/api/chat/tree')  // é”™è¯¯: /api/v1/api/chat/tree
```

### 2. IPC å‘½åè§„èŒƒ
- **æ ¼å¼**: `æ¨¡å—:æ“ä½œ`
- **ç¤ºä¾‹**: `chat:getChatTree`, `ssh:connect`, `settings:save`

```typescript
// âœ… æ­£ç¡®
ipcMain.handle('chat:getChatTree', ...)
ipcMain.handle('ssh:connect', ...)

// âŒ é”™è¯¯
ipcMain.handle('getChatTree', ...)  // ç¼ºå°‘æ¨¡å—å‰ç¼€
ipcMain.handle('chat_get_tree', ...)  // ä½¿ç”¨ä¸‹åˆ’çº¿
```

### 3. è·¯ç”±å“åº”æ ¼å¼è§„èŒƒ
- **å¿…é¡»**ä½¿ç”¨ç»Ÿä¸€çš„å“åº” Schema (`packages/server/src/schemas/common.schema.ts`)
- **ç¦æ­¢**ä¸ºæ¯ä¸ªè·¯ç”±é‡å¤å®šä¹‰è¯¦ç»†çš„ response schema
- **200 å“åº”**ç»Ÿä¸€ä½¿ç”¨ `successResponseSchema`ï¼ˆå…è®¸ä»»æ„å¯¹è±¡ï¼Œé¿å…åºåˆ—åŒ–é—®é¢˜ï¼‰

```typescript
// âœ… æ­£ç¡®
import { successResponseSchema } from '../schemas/common.schema.js'

fastify.get('/settings', {
  schema: {
    description: 'è·å–ç”¨æˆ·è®¾ç½®',
    tags: ['è®¾ç½®'],
    response: successResponseSchema  // ç»Ÿä¸€ä½¿ç”¨
  }
}, async (request, reply) => {
  return reply.send({
    success: true,
    message: 'è·å–æˆåŠŸ',
    data: { /* ä»»æ„ç»“æ„ */ }
  })
})

// âŒ é”™è¯¯ - é‡å¤å®šä¹‰ä¸”å¯èƒ½å¯¼è‡´åºåˆ—åŒ–é—®é¢˜
response: {
  200: {
    type: 'object',
    properties: {
      success: { type: 'boolean' },
      data: { type: 'object' }  // æ²¡æœ‰ additionalProperties: true
    }
  }
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ç»Ÿä¸€ Schemaï¼Ÿ**
- âœ… é¿å… Fastify åºåˆ—åŒ–å™¨å› ç¼ºå°‘ `additionalProperties: true` è€Œè·³è¿‡å­—æ®µ
- âœ… ç»Ÿä¸€ç®¡ç†ï¼Œä¿®æ”¹å“åº”æ ¼å¼åªéœ€æ›´æ–°ä¸€ä¸ªåœ°æ–¹
- âœ… å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§
- âœ… å…è®¸åŠ¨æ€å­—æ®µï¼Œæ”¯æŒçµæ´»çš„å“åº”ç»“æ„

**å¯ç”¨çš„ Schema é€‰é¡¹**ï¼š
- `successResponseSchema` - ä»… 200 å“åº”
- `errorResponseSchema` - é”™è¯¯å“åº”ï¼ˆ400/401/404/500ï¼‰
- `standardResponseSchema` - å®Œæ•´å“åº”ï¼ˆæˆåŠŸ+é”™è¯¯ï¼‰

### 4. ç±»å‹å®šä¹‰åŒæ­¥
- **å¿…é¡»**åŒæ­¥æ›´æ–° `apps/desktop/src/types/electron.d.ts`
- Preload è„šæœ¬æ¯æ¬¡æ·»åŠ æ–° APIï¼Œéƒ½è¦æ›´æ–°ç±»å‹å®šä¹‰

### 5. Token ç®¡ç†
- **å­˜å‚¨ key**: å›ºå®šä½¿ç”¨ `'userToken'`ï¼ˆä¸æ˜¯ `'token'`ï¼‰
- **å­˜å‚¨ä½ç½®**: `localStorage` æˆ– `sessionStorage`
- **ç¦æ­¢**ç»„ä»¶æ‰‹åŠ¨å¤„ç† Tokenï¼Œç”±æœåŠ¡å±‚è‡ªåŠ¨å¤„ç†

```typescript
// âœ… æ­£ç¡®
localStorage.setItem('userToken', accessToken)

// âŒ é”™è¯¯
localStorage.setItem('token', accessToken)
```

## ğŸ—„ï¸ æ•°æ®å­˜å‚¨è§„èŒƒ

### 1. æœ¬åœ°å­˜å‚¨ï¼ˆSQLiteï¼‰
- **å·¥å…·**: better-sqlite3
- **è¡¨ç»“æ„**:
  ```sql
  CREATE TABLE IF NOT EXISTS table_name (
    id TEXT PRIMARY KEY,
    userId TEXT NOT NULL,
    -- ä¸šåŠ¡å­—æ®µ
    createdAt TEXT DEFAULT CURRENT_TIMESTAMP,
    updatedAt TEXT DEFAULT CURRENT_TIMESTAMP
  );
  CREATE INDEX IF NOT EXISTS idx_table_userId ON table_name(userId);
  ```
- **å¿…é¡»**ä½¿ç”¨ Prepared Statement é˜²æ­¢ SQL æ³¨å…¥
  ```typescript
  // âœ… æ­£ç¡®
  const stmt = this.db.prepare('SELECT * FROM notes WHERE userId = ?')
  return stmt.all(userId)
  
  // âŒ é”™è¯¯
  return this.db.exec(`SELECT * FROM notes WHERE userId = '${userId}'`)
  ```

### 2. äº‘ç«¯å­˜å‚¨ï¼ˆPostgreSQLï¼‰
- **ORM**: Prisma
- **ä½ç½®**: `packages/database/prisma/schema.prisma`
- **è¿ç§»**: `pnpm prisma migrate dev --name xxx`

### 3. æœåŠ¡å®ç°ä½ç½®
- **æœ¬åœ°æœåŠ¡**: `apps/desktop/electron/services/`
- **IPC å¤„ç†å™¨**: `apps/desktop/electron/ipc/`
- **äº‘ç«¯æœåŠ¡**: `packages/server/src/services/`
- **API è·¯ç”±**: `packages/server/src/routes/`
- **å‰ç«¯æœåŠ¡**: `apps/desktop/src/services/`

## ğŸ”§ å¼€å‘æµç¨‹

### 1. æ·»åŠ æ–°åŠŸèƒ½æ¨¡å—
1. å®šä¹‰æœåŠ¡æ¥å£ (`apps/desktop/src/services/your.service.ts`)
2. å®ç°æœ¬åœ°æœåŠ¡ (`apps/desktop/electron/services/your.service.ts`)
3. æ³¨å†Œ IPC å¤„ç†å™¨ (`apps/desktop/electron/ipc/your-handlers.ts`)
4. æ›´æ–° Preload è„šæœ¬ (`apps/desktop/electron/preload/index.ts`)
5. æ›´æ–°ç±»å‹å®šä¹‰ (`apps/desktop/src/types/electron.d.ts`)
6. å®ç°äº‘ç«¯æœåŠ¡ (`packages/server/src/services/your.service.ts`)
7. åˆ›å»º API è·¯ç”± (`packages/server/src/routes/your.routes.ts`)
8. å®ç°åŒæ¨¡å¼æœåŠ¡ï¼ˆLocalImpl + ApiImplï¼‰
9. åˆ›å»º UI ç»„ä»¶

### 2. Git æäº¤è§„èŒƒ
- **å®Œæˆä»»åŠ¡åå¿…é¡»æäº¤**: `git add . && git commit -m "ç®€çŸ­è¯´æ˜" && git push`
- **commit ä¿¡æ¯è¦ç®€çŸ­æ˜ç¡®**ï¼Œè¯´æ˜åšäº†ä»€ä¹ˆ
- **ä¸è¦**è·³è¿‡ hooksï¼ˆé™¤éæ˜ç¡®éœ€è¦ï¼‰
- **ä¸è¦** force push åˆ° main/master

### 3. è°ƒè¯•æŠ€å·§
- **ä¸è¦æ€€ç–‘**ä»£ç æœªç”Ÿæ•ˆæ˜¯å› ä¸ºæ²¡æœ‰ç¼–è¯‘æˆ–é‡å¯
- **ä½¿ç”¨**è¯¦ç»†æ—¥å¿—è®°å½•å…³é”®èŠ‚ç‚¹
- **éªŒè¯æ•°æ®æµ**:
  - æœ¬åœ°: ç»„ä»¶ â†’ Service â†’ IPC â†’ ä¸»è¿›ç¨‹ â†’ SQLite
  - äº‘ç«¯: ç»„ä»¶ â†’ Service â†’ API â†’ åç«¯ â†’ Prisma â†’ PostgreSQL

## âš ï¸ å¸¸è§é”™è¯¯é¿å…

### 1. ç¦æ­¢çš„æ“ä½œ
- âŒ åˆ›å»ºæˆ–ä½¿ç”¨ Pinia Storeï¼ˆå·²åºŸå¼ƒï¼‰
- âŒ åœ¨ç»„ä»¶ä¸­æ‰‹åŠ¨åˆ¤æ–­å­˜å‚¨æ¨¡å¼
- âŒ æ‰‹åŠ¨ä¼ é€’ userId å‚æ•°
- âŒ æ‰‹åŠ¨å¤„ç† Token
- âŒ API è·¯å¾„æ·»åŠ é‡å¤çš„ `/api` å‰ç¼€
- âŒ å­—ç¬¦ä¸²æ‹¼æ¥ SQLï¼ˆä½¿ç”¨ Prepared Statementï¼‰
- âŒ ç›´æ¥è¿æ¥è¿œç¨‹æ•°æ®åº“ï¼ˆä½¿ç”¨ APIï¼‰
- âŒ ä¸ºæ¯ä¸ªè·¯ç”±é‡å¤å®šä¹‰è¯¦ç»†çš„ response schema
- âŒ åœ¨ response schema ä¸­å®šä¹‰ `type: 'object'` è€Œä¸åŠ  `additionalProperties: true`

### 2. å¿…é¡»çš„æ“ä½œ
- âœ… ä½¿ç”¨ç»Ÿä¸€æœåŠ¡æ¥å£
- âœ… æœåŠ¡å±‚è‡ªåŠ¨å¤„ç† userId å’Œ Token
- âœ… åŒæ­¥æ›´æ–°ç±»å‹å®šä¹‰
- âœ… ä½¿ç”¨ Prepared Statement
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
- âœ… è·¯ç”±ä½¿ç”¨ç»Ÿä¸€çš„ `successResponseSchema`

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Service Architecture](./docs/development/service-architecture.md) - æœåŠ¡æ¶æ„è¯¦ç»†è¯´æ˜
- [Database Storage](./docs/development/database-storage.md) - æ•°æ®å­˜å‚¨æ¶æ„
- [Best Practices](./docs/development/best-practices.md) - æœ€ä½³å®è·µ
- [Getting Started](./docs/development/getting-started.md) - å¼€å‘å…¥é—¨

## ğŸ” ä»£ç æ£€æŸ¥æ¸…å•

### æ·»åŠ æ–°åŠŸèƒ½å‰æ£€æŸ¥
- [ ] æ˜¯å¦éœ€è¦å®šä¹‰æœåŠ¡æ¥å£ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æœ¬åœ°å’Œäº‘ç«¯ä¸¤ç§å®ç°ï¼Ÿ
- [ ] ç±»å‹å®šä¹‰æ˜¯å¦åŒæ­¥æ›´æ–°ï¼Ÿ
- [ ] IPC å‘½åæ˜¯å¦ç¬¦åˆè§„èŒƒï¼Ÿ
- [ ] API è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆæ— é‡å¤å‰ç¼€ï¼‰ï¼Ÿ
- [ ] è·¯ç”±æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€çš„ `successResponseSchema`ï¼Ÿ

### æäº¤ä»£ç å‰æ£€æŸ¥
- [ ] æ˜¯å¦æœ‰ TypeScript é”™è¯¯ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ linter é”™è¯¯ï¼Ÿ
- [ ] userId å’Œ Token æ˜¯å¦ç”±æœåŠ¡å±‚å¤„ç†ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æœªæ¸…ç†çš„äº‹ä»¶ç›‘å¬å™¨ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ SQL æ³¨å…¥é£é™©ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„é…ç½®ï¼ˆåº”ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰ï¼Ÿ

### ç»„ä»¶å¼€å‘æ£€æŸ¥
- [ ] æ˜¯å¦ç›´æ¥ä½¿ç”¨æœåŠ¡è€Œé Storeï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ Composables ç®¡ç†å…¨å±€çŠ¶æ€ï¼Ÿ
- [ ] æ˜¯å¦æ­£ç¡®æ¸…ç†å‰¯ä½œç”¨ï¼ˆonBeforeUnmountï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†ï¼Ÿ

---

**æœ€åæ›´æ–°**: 2025-10-08
**é¡¹ç›®æ¶æ„ç‰ˆæœ¬**: v2.0 (åŒæ¨¡å¼æœåŠ¡æ¶æ„)
