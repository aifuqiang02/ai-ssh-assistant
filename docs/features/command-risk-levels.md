# 命令风险等级系统

## 概述

AI 助手现在支持命令风险等级评估系统，可以根据命令的危险程度自动判断是否需要用户确认。系统将命令分为 5 个风险等级，用户可以在设置中配置自动执行的最高风险等级。

## 风险等级定义

### 等级 1: 只读命令 (✅ 最安全)
这些命令只读取信息，不会对系统做任何修改：
- `ls`, `ll` - 列出文件和目录
- `pwd` - 显示当前目录
- `cd` - 切换目录
- `cat`, `less`, `more` - 查看文件内容
- `head`, `tail` - 查看文件开头/结尾
- `grep` - 搜索文本
- `find` - 查找文件
- `wc` - 统计行数/字数
- `diff` - 比较文件
- `echo`, `printf` - 输出文本
- `stat`, `file` - 查看文件信息
- `tree` - 显示目录树
- `type` - 显示命令类型

### 等级 2: 查看系统状态 (✅ 安全)
这些命令查看系统运行状态，不修改任何内容：
- `ps`, `top`, `htop` - 查看进程
- `df`, `du` - 查看磁盘使用情况
- `free` - 查看内存使用
- `uptime` - 系统运行时间
- `who`, `w` - 查看在线用户
- `netstat`, `ss` - 查看网络连接
- `lsof` - 查看打开的文件
- `uname`, `hostname` - 系统信息
- `ifconfig`, `ip addr` - 网络配置
- `route` - 路由表
- `ping`, `traceroute` - 网络测试
- `history` - 命令历史
- `env`, `printenv` - 环境变量
- `date`, `cal` - 日期时间
- `which`, `whereis`, `locate` - 查找命令/文件

### 等级 3: 文件操作 (⚠️ 需谨慎)
这些命令会创建、复制、移动文件，但不删除：
- `mkdir` - 创建目录
- `touch` - 创建空文件
- `cp` - 复制文件
- `mv` - 移动/重命名文件
- `ln` - 创建链接
- `tar`, `zip`, `unzip`, `gzip`, `gunzip` - 压缩/解压
- `wget`, `curl -o` - 下载文件
- `scp`, `rsync` - 远程复制/同步
- `git clone`, `git pull` - Git 操作
- `npm install`, `apt install`, `yum install` - 安装软件包

### 等级 4: 删除/修改操作 (⚠️ 危险)
这些命令会删除或修改文件和权限：
- `rm`, `rmdir` - 删除文件/目录
- `chmod` - 修改权限
- `chown`, `chgrp` - 修改所有者/组
- `sed -i` - 原地修改文件
- `truncate` - 截断文件
- `>`, `>>` - 重定向（覆盖/追加）
- `kill`, `pkill`, `killall` - 终止进程

### 等级 5: 系统级操作 (⛔ 极度危险)
这些命令会对系统做重大修改，可能导致系统崩溃或数据丢失：
- `sudo` - 超级用户权限
- `su` - 切换用户
- `systemctl`, `service` - 系统服务管理
- `reboot`, `shutdown`, `halt` - 重启/关机
- `init` - 改变运行级别
- `kill -9`, `pkill -9` - 强制杀进程
- `dd` - 磁盘读写
- `fdisk`, `mkfs` - 分区/格式化
- `mount`, `umount` - 挂载/卸载
- `iptables`, `firewall` - 防火墙配置
- `useradd`, `userdel` - 用户管理
- `passwd` - 修改密码

## 如何使用

### 在设置中配置

1. 打开 **设置** → **AI 助手**
2. 找到 **命令自动执行风险等级** 选项
3. 选择您希望自动执行的最高风险等级：
   - **🚫 全部需要确认** (0级): 所有命令都需要您的确认
   - **✅ 等级1: 只读命令**: 自动执行只读命令（如 ls, cat）
   - **✅ 等级2: 查看状态**: 自动执行查看系统状态的命令（如 ps, free）
   - **✅ 等级3: 文件操作**: 自动执行文件操作命令，不含删除（如 mkdir, cp）
   - **⚠️ 等级4: 删除修改**: 自动执行删除和修改命令（谨慎！）
   - **⛔ 等级5: 系统操作**: 自动执行所有命令包括系统级操作（危险！）

### 推荐配置

- **新手用户**: 选择 **等级 1** 或 **等级 2**，只自动执行安全的查看命令
- **高级用户**: 可以选择 **等级 3**，允许自动执行常见的文件操作
- **开发环境**: 如果是在测试环境，可以选择 **等级 4**
- **生产环境**: 强烈建议选择 **等级 1** 或 **等级 2**，确保所有危险操作都需要确认

## 工作原理

1. **命令评估**: 当 AI 助手请求执行 SSH 命令时，系统会自动分析命令内容
2. **风险判断**: 通过正则表达式匹配命令模式，判断其风险等级（1-5）
3. **自动批准**: 如果命令风险等级 ≤ 设置的等级，自动执行；否则弹出确认对话框
4. **风险提示**: 需要确认的命令会显示其风险等级标签（如 `[风险等级4: ⚠️ 删除]`）

## 示例

### 场景 1: 设置为等级 2
```bash
ls -la          # ✅ 自动执行（等级1）
ps aux          # ✅ 自动执行（等级2）
mkdir test      # ⚠️ 需要确认（等级3）
rm test.txt     # ⚠️ 需要确认（等级4）
sudo reboot     # ⚠️ 需要确认（等级5）
```

### 场景 2: 设置为等级 3
```bash
cat file.txt    # ✅ 自动执行（等级1）
df -h           # ✅ 自动执行（等级2）
cp file1 file2  # ✅ 自动执行（等级3）
chmod 777 file  # ⚠️ 需要确认（等级4）
```

## 注意事项

1. **默认风险等级**: 未识别的命令默认为等级 3（中等风险）
2. **组合命令**: 管道和组合命令取最高风险等级
3. **特殊工具**: `attempt_completion`（任务完成）等工具始终自动执行
4. **只读工具**: `read_file`、`list_files` 等文件浏览工具遵循"自动批准只读操作"设置
5. **风险评估**: 系统基于命令关键字进行判断，某些复杂命令可能评估不准确

## 安全建议

- 🔐 **生产服务器**: 始终使用等级 1 或 2
- 🧪 **测试环境**: 可以使用等级 3 提高效率
- 👨‍💻 **开发环境**: 根据个人习惯选择合适等级
- ⚠️ **重要操作**: 涉及删除、权限修改时，务必仔细确认
- 🚫 **系统命令**: sudo、reboot 等操作，建议手动执行

## 相关设置

- **自动批准只读操作**: 与风险等级系统配合使用，专门针对文件浏览类工具
- **对话历史**: 保存 AI 助手的对话记录，便于追溯命令执行历史
- **最大历史消息数**: 控制保留的对话消息数量

## 更新日志

- **v1.0.0** (2025-10-06): 初始版本，实现 5 级风险评估系统

